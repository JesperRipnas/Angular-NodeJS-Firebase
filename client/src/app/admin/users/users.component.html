<section class="users-container">
  <div class="users-panel">
    <div class="filters-card" aria-label="User filters">
      <div class="search-row" role="search">
        <div class="search-controls">
          <div class="search-input-wrapper">
            <svg class="search-icon" viewBox="0 0 24 24" aria-hidden="true">
              <path
                d="M15.5 14h-.79l-.28-.27a6 6 0 10-.71.71l.27.28v.79l4.25 4.25 1.27-1.27L15.5 14zm-5.5 0a4.5 4.5 0 110-9 4.5 4.5 0 010 9z"
              />
            </svg>
            <input
              id="user-search"
              class="search-input"
              type="search"
              [value]="searchTerm()"
              (input)="onSearchInput($event)"
              [placeholder]="
                translation.translate('admin.users.search.placeholder')
              "
              [attr.aria-describedby]="'user-search-help'"
            />
          </div>
          <button
            class="btn btn-filter-toggle"
            type="button"
            (click)="toggleFilters()"
          >
            <span class="filter-toggle-text">
              {{
                showFilters()
                  ? translation.translate('admin.users.filters.hide')
                  : translation.translate('admin.users.filters.show')
              }}
            </span>
            <span
              class="filter-toggle-icon"
              [class.is-open]="showFilters()"
              aria-hidden="true"
            >
              â–¾
            </span>
          </button>
        </div>
      </div>

      @if (showFilters()) {
        <div class="filters-grid">
          <fieldset class="filter-field">
            <legend class="filter-label">
              {{ translation.translate('admin.users.search.roleLabel') }}
            </legend>
            <div class="filter-options">
              <label class="filter-option">
                <input
                  type="checkbox"
                  [checked]="isAllRolesSelected()"
                  (change)="toggleAllRoles($event.target.checked)"
                />
                <span>{{
                  translation.translate('admin.users.search.allRoles')
                }}</span>
              </label>
              @for (option of roleOptions; track option.value) {
                <label class="filter-option">
                  <input
                    type="checkbox"
                    [checked]="isRoleSelected(option.value)"
                    (change)="toggleRole(option.value, $event.target.checked)"
                  />
                  <span>{{ translation.translate(option.labelKey) }}</span>
                </label>
              }
            </div>
          </fieldset>

          <fieldset class="filter-field">
            <legend class="filter-label">
              {{
                translation.translate('admin.users.search.verificationLabel')
              }}
            </legend>
            <div class="filter-options">
              @for (option of verificationOptions; track option.value) {
                <label class="filter-option">
                  <input
                    type="checkbox"
                    [checked]="isVerificationSelected(option.value)"
                    (change)="
                      toggleVerification(option.value, $event.target.checked)
                    "
                  />
                  <span>{{ translation.translate(option.labelKey) }}</span>
                </label>
              }
            </div>
          </fieldset>
        </div>
      }
    </div>

    @if (isLoading()) {
      <div class="loading">{{ translation.translate('shared.loading') }}</div>
    } @else {
      <div class="users-table">
        <table>
          <colgroup>
            <col class="col-username" />
            <col class="col-email" />
            <col class="col-first-name" />
            <col class="col-last-name" />
            <col class="col-created" />
            <col class="col-updated" />
            <col class="col-verified" />
            <col class="col-role" />
            <col class="col-actions" />
          </colgroup>
          <thead>
            <tr>
              <th [attr.aria-sort]="getAriaSort('username')">
                <button
                  type="button"
                  class="sort-button"
                  (click)="toggleSort('username')"
                >
                  {{ translation.translate('admin.users.table.username') }}
                  <span class="sort-indicator">{{
                    getSortIndicator('username')
                  }}</span>
                </button>
              </th>
              <th [attr.aria-sort]="getAriaSort('email')">
                <button
                  type="button"
                  class="sort-button"
                  (click)="toggleSort('email')"
                >
                  {{ translation.translate('admin.users.table.email') }}
                  <span class="sort-indicator">{{
                    getSortIndicator('email')
                  }}</span>
                </button>
              </th>
              <th [attr.aria-sort]="getAriaSort('firstName')">
                <button
                  type="button"
                  class="sort-button"
                  (click)="toggleSort('firstName')"
                >
                  {{ translation.translate('admin.users.modal.firstName') }}
                  <span class="sort-indicator">{{
                    getSortIndicator('firstName')
                  }}</span>
                </button>
              </th>
              <th [attr.aria-sort]="getAriaSort('lastName')">
                <button
                  type="button"
                  class="sort-button"
                  (click)="toggleSort('lastName')"
                >
                  {{ translation.translate('admin.users.modal.lastName') }}
                  <span class="sort-indicator">{{
                    getSortIndicator('lastName')
                  }}</span>
                </button>
              </th>
              <th [attr.aria-sort]="getAriaSort('createdAt')">
                <button
                  type="button"
                  class="sort-button"
                  (click)="toggleSort('createdAt')"
                >
                  {{ translation.translate('admin.users.table.createdAt') }}
                  <span class="sort-indicator">{{
                    getSortIndicator('createdAt')
                  }}</span>
                </button>
              </th>
              <th [attr.aria-sort]="getAriaSort('updatedAt')">
                <button
                  type="button"
                  class="sort-button"
                  (click)="toggleSort('updatedAt')"
                >
                  {{ translation.translate('admin.users.table.updatedAt') }}
                  <span class="sort-indicator">{{
                    getSortIndicator('updatedAt')
                  }}</span>
                </button>
              </th>
              <th
                class="col-center"
                [attr.aria-sort]="getAriaSort('verifiedEmail')"
              >
                <button
                  type="button"
                  class="sort-button"
                  (click)="toggleSort('verifiedEmail')"
                >
                  {{ translation.translate('admin.users.table.verifiedEmail') }}
                  <span class="sort-indicator">{{
                    getSortIndicator('verifiedEmail')
                  }}</span>
                </button>
              </th>
              <th [attr.aria-sort]="getAriaSort('role')">
                <button
                  type="button"
                  class="sort-button"
                  (click)="toggleSort('role')"
                >
                  {{ translation.translate('admin.users.table.role') }}
                  <span class="sort-indicator">{{
                    getSortIndicator('role')
                  }}</span>
                </button>
              </th>
              <th class="col-center"></th>
            </tr>
          </thead>
          <tbody>
            @if (pagedUsers().length > 0) {
              @for (user of pagedUsers(); track user.uuid) {
                <tr>
                  <td>{{ user.username }}</td>
                  <td>{{ user.email }}</td>
                  <td>{{ user.firstName }}</td>
                  <td>{{ user.lastName }}</td>
                  <td class="date-cell">{{ formatDate(user.createdAt) }}</td>
                  <td class="date-cell">
                    {{
                      user.updatedAt
                        ? formatDate(user.updatedAt)
                        : translation.translate('shared.no')
                    }}
                  </td>
                  <td class="col-center">
                    {{
                      user.verifiedEmail
                        ? translation.translate('shared.yes')
                        : translation.translate('shared.no')
                    }}
                  </td>
                  <td>
                    <span class="role-badge" [class]="'role-' + user.role">
                      {{ user.role }}
                    </span>
                  </td>
                  <td class="col-center">
                    <div class="actions-cell">
                      <button
                        class="icon-button icon-button-edit"
                        (click)="openEditModal(user)"
                        [disabled]="isSaving()"
                        [attr.aria-label]="
                          translation.translate('admin.users.buttons.edit')
                        "
                        [attr.title]="
                          translation.translate('admin.users.buttons.edit')
                        "
                      >
                        <svg
                          viewBox="0 0 24 24"
                          aria-hidden="true"
                          focusable="false"
                        >
                          <path
                            d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zm2.92 2.83H5v-.92l8.06-8.06.92.92L5.92 20.08zM20.71 7.04a1.003 1.003 0 000-1.42l-2.34-2.34a1.003 1.003 0 00-1.42 0l-1.83 1.83 3.75 3.75 1.84-1.82z"
                          />
                        </svg>
                      </button>
                      <button
                        class="icon-button icon-button-delete"
                        (click)="deleteUser(user.uuid)"
                        [disabled]="isSaving() || isLastAdmin(user)"
                        [attr.aria-label]="
                          translation.translate('admin.users.buttons.delete')
                        "
                        [attr.title]="
                          isLastAdmin(user)
                            ? translation.translate(
                                'admin.users.messages.lastAdminDeleteProtection'
                              )
                            : translation.translate(
                                'admin.users.buttons.delete'
                              )
                        "
                      >
                        <svg
                          viewBox="0 0 24 24"
                          aria-hidden="true"
                          focusable="false"
                        >
                          <path
                            d="M6 7h12l-1 14H7L6 7zm3-3h6l1 1h4v2H4V5h4l1-1z"
                          />
                        </svg>
                      </button>
                    </div>
                  </td>
                </tr>
              }
            } @else {
              <tr>
                <td class="no-results" colspan="7">
                  {{ translation.translate('admin.users.search.noResults') }}
                </td>
              </tr>
            }
          </tbody>
        </table>
        <app-paginator
          [totalItems]="filteredUsers().length"
          [pageSize]="pageSize()"
          [pageIndex]="pageIndex()"
          [pageSizeOptions]="pageSizeOptions"
          [pageSizeLabel]="translation.translate('shared.pagination.pageSize')"
          [pageSizeAriaLabel]="
            translation.translate('shared.pagination.pageSizeAria')
          "
          [previousLabel]="translation.translate('shared.pagination.previous')"
          [nextLabel]="translation.translate('shared.pagination.next')"
          (pageChange)="onPageChange($event)"
          (pageSizeChange)="onPageSizeChange($event)"
        ></app-paginator>
      </div>
    }
  </div>
</section>

@if (selectedUserForEdit()) {
  <app-edit-user-modal
    [user]="selectedUserForEdit()"
    [adminCount]="adminCount()"
    [existingUsers]="users()"
    (closeModal)="closeEditModal()"
    (saveUser)="saveEditedUser($event)"
  ></app-edit-user-modal>
}
